---
title: "Decision Modeling for Agroecology & Conservation"
author: "Cory Whitney"
date: "`r Sys.Date()`"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("functions/monte_carlo.R")
source("functions/apples_sheep_in_class.R")
```

# **Introduction**

Welcome to the interactive tutorial on **Decision Modeling for Agroecology & Conservation**. 
This tutorial will guide you through:

- **Theoretical foundations** of decision modeling 
- **Identifying decision options and outcomes** 
- **Structuring causal models** using Directed Acyclic Graphs (DAGs)
- **Monte Carlo simulation** for decision-making
- **Expert-elicited probabilities** and model validation
- **Evaluating models** with EVPI and Pareto-optimality

---

## **1. The Need for Decision Modeling in Agroecology**

- **Application of decision modeling in agroecology**
- **The role of expert knowledge**
- **Decision structuring** 

```{r question1, echo=FALSE}
quiz(
  question("What is a good reason to use a probabilistic approach to support decision-making in agroecology?",
    answer("It captures uncertainty in outcomes and trade-offs.", correct = TRUE),
    answer("It provides fixed deterministic solutions.", correct = FALSE),
    answer("It replaces the need for expert knowledge.", correct = FALSE),
    answer("It avoids the need for validation.", correct = FALSE)
  )
)
```

---

## **2. Identifying Decision Options and Outcomes**

**Activity:** Identify and list **decision options** and **outcomes of interest** from the perspective of decision-makers.

```{r decision_options, echo=FALSE}
textInput("decision_options", "List the decision options relevant to an agroecological problem:", placeholder="Example: Adopting agroforestry, expanding irrigation, switching to organic inputs...")
```

```{r decision_outcomes, echo=FALSE}
textInput("decision_outcomes", "List the key outcomes of interest for decision-makers:", placeholder="Example: Yield improvement, biodiversity conservation, financial returns...")
```

---

## **3. Structuring a Causal Decision Model (DAGs)**

**Activity:** Sketch a decision model using the interactive diagram tool or upload a hand-drawn image.

### **Option 1: Interactive DAG Drawing**

Share a link of a graph you build in [Loopy](https://ncase.me/loopy/) by [Explorable Explanations](http://explorableexplanations.com/)

### **Option 2: Upload a Hand-Drawn Model**

```{r upload_model, echo=FALSE}
fileInput("model_upload", "Upload your decision model (optional)", accept = c("image/png", "image/jpeg"))
```

---

## **4. Implementing the Apple-Sheep Monte Carlo Model**

Now for a very simple **Monte Carlo Simulation** in R. We will analyze a **decision**. The choice of a farmer to start agroforestry (apple trees + sheep) or maintain a treeless sheep system. Use `set.seed` and change the number of simulations to 1000

```{r apples_sheep_in_class, exercise=TRUE}

# set.seed(42)
num_simulations <- 100

# Define ranges per ha per year Euro
# lower and upper
apple_income_range <- c(3000, 60000)
apple_costs_range <- c(15000, 30000)

apple_income <- runif(n = num_simulations, 
                      min = apple_income_range[1], 
                      max = apple_income_range[2])

apple_costs <- runif(n = num_simulations, 
                      min = apple_costs_range[1], 
                     max = apple_costs_range[2])

apple_profits <- apple_income - apple_costs

hist(apple_profits)

abline(v = quantile(apple_profits, 
                    c(0.1, 0.5, 0.9), 
                    lwd = 10)) # lwd = line width

# Add sheep to the horticulture system 
# Now it is silvopastoral 

# Euro per ha per year
sheep_income_range <- c(2000, 5000)
sheep_costs_range <- c(1000, 2500)

sheep_income <- runif(n = num_simulations, 
                      min = sheep_income_range[1], 
                      max = sheep_income_range[2])

sheep_costs <- runif(n = num_simulations, 
                     min = sheep_costs_range[1], 
                     max = sheep_costs_range[2])

sheep_profits <- sheep_income - sheep_costs

total_profits <- apple_profits + sheep_profits
```

```{r apples_sheep_in_class-solution}

set.seed(42)
num_simulations <- 1000

# Define ranges per ha per year Euro
# lower and upper
apple_income_range <- c(3000, 60000)
apple_costs_range <- c(15000, 30000)

apple_income <- runif(n = num_simulations, 
                      min = apple_income_range[1], 
                      max = apple_income_range[2])

apple_costs <- runif(n = num_simulations, 
                      min = apple_costs_range[1], 
                     max = apple_costs_range[2])

apple_profits <- apple_income - apple_costs

hist(apple_profits)

abline(v = quantile(apple_profits, 
                    c(0.1, 0.5, 0.9), 
                    lwd = 10)) # lwd = line width

# Add sheep to the horticulture system 
# Now it is silvopastoral 

# Euro per ha per year
sheep_income_range <- c(2000, 5000)
sheep_costs_range <- c(1000, 2500)

sheep_income <- runif(n = num_simulations, 
                      min = sheep_income_range[1], 
                      max = sheep_income_range[2])

sheep_costs <- runif(n = num_simulations, 
                     min = sheep_costs_range[1], 
                     max = sheep_costs_range[2])

sheep_profits <- sheep_income - sheep_costs

total_profits <- apple_profits + sheep_profits
```

Plot a histogram of the model. Change the color of the apple_profits to grey. 

```{r plot_profits_overlay, exercise=TRUE}
hist(total_profits, col = "white")
hist(apple_profits, add = TRUE, col = "pink")
hist(sheep_profits, add = TRUE, col = "black")
```

```{r plot_profits_overlay-solution}
hist(total_profits, col = "white")
hist(apple_profits, add = TRUE, col = "grey")
hist(sheep_profits, add = TRUE, col = "black")
```

---

## Let's build a similar model with the `decisionSupport` package

### **Define Input Estimates**

Adjust these as you see fit. The lower bounds could be lower for example. 

```{r apple_sheep_estimates, exercise=TRUE}
input_estimates <- data.frame(
  variable = c("sheep_income", "sheep_cost", "apple_income", "apple_cost", "discount_rate"),
  lower = c(3000, 1000, 30000, 15000, 10),
  median = NA,
  upper = c(5000, 2500, 60000, 30000, 10),
  distribution = c("posnorm", "posnorm", "posnorm", "posnorm", "const"),
  label = c("Income from sheep (euro/year)", "Cost of sheep (euro/year)", "Income from apple (euro/year)", "Cost of apple (euro/year)", "Discount Rate")
)
```

```{r apple_sheep_estimates-solution}
input_estimates <- data.frame(
  variable = c("sheep_income", "sheep_cost", "apple_income", "apple_cost", "discount_rate"),
  lower = c(300, 100, 3000, 1500, 1),
  median = NA,
  upper = c(5000, 2500, 60000, 30000, 10),
  distribution = c("posnorm", "posnorm", "posnorm", "posnorm", "const"),
  label = c("Income from sheep (euro/year)", "Cost of sheep (euro/year)", "Income from apple (euro/year)", "Cost of apple (euro/year)", "Discount Rate")
)
```

### **Build the Decision Model Function**

Adjust as you see fit. Add the income from agroforestry `AF_income` to the return for example.

```{r apple_sheep_model_function, exercise=TRUE}
model_function <- function() {
  AF_income <- sheep_income + apple_income
  AF_cost <- sheep_cost + apple_cost
  AF_final_result <- AF_income - AF_cost
  sheep_only <- sheep_income - sheep_cost
  Decision_benefit <- AF_final_result - sheep_only
  
  AF_NPV <- discount(AF_final_result, discount_rate = discount_rate, calculate_NPV = TRUE)
  NPV_sheep_only <- discount(sheep_only, discount_rate = discount_rate, calculate_NPV = TRUE)
  NPV_decision <- discount(Decision_benefit, discount_rate = discount_rate, calculate_NPV = TRUE)
  
  return(list(
    NPV_Agroforestry_System = AF_NPV,
    NPV_Treeless_System = NPV_sheep_only,
    NPV_decision = NPV_decision
  ))
}
```

```{r apple_sheep_model_function-solution}
model_function <- function() {
  AF_income <- sheep_income + apple_income
  AF_cost <- sheep_cost + apple_cost
  AF_final_result <- AF_income - AF_cost
  sheep_only <- sheep_income - sheep_cost
  Decision_benefit <- AF_final_result - sheep_only
  
  AF_NPV <- discount(AF_final_result, discount_rate = discount_rate, calculate_NPV = TRUE)
  NPV_sheep_only <- discount(sheep_only, discount_rate = discount_rate, calculate_NPV = TRUE)
  NPV_decision <- discount(Decision_benefit, discount_rate = discount_rate, calculate_NPV = TRUE)
  
  return(list(
    NPV_Agroforestry_System = AF_NPV,
    NPV_Treeless_System = NPV_sheep_only,
    NPV_decision = NPV_decision, 
    AF_income = AF_income
  ))
}
```

### **Run the Monte Carlo Simulation**

Adjust the number of simulations to `1000`. 

```{r apple_sheep_mc, exercise=TRUE}
apple_sheep_mc_simulation <- mcSimulation(
  estimate = as.estimate(input_estimates),
  model_function = model_function,
  numberOfModelRuns = 100,
  functionSyntax = "plainNames"
)
```

```{r apple_sheep_mc-solution}
apple_sheep_mc_simulation <- mcSimulation(
  estimate = as.estimate(input_estimates),
  model_function = model_function,
  numberOfModelRuns = 1000,
  functionSyntax = "plainNames"
)
```

---

## **5. Expert Knowledge & Validation (EVPI & Pareto-Optimality)**

### **Expected Value of Perfect Information (EVPI)**

```{r evpi_calc, exercise=TRUE}
mcSimulation_table <- data.frame(apple_sheep_mc_simulation$x, apple_sheep_mc_simulation$y[3])
evpi <- multi_EVPI(mc = mcSimulation_table, first_out_var = "NPV_decision")
evpi
```

```{r evpi_calc-solution}
mcSimulation_table <- data.frame(apple_sheep_mc_simulation$x, apple_sheep_mc_simulation$y[3])
evpi <- multi_EVPI(mc = mcSimulation_table, first_out_var = "NPV_decision")
evpi
```

### **Trade-Off Analysis Using Pareto-Optimality**

```{r pareto_analysis, exercise=TRUE}
decision1 <- apple_sheep_mc_simulation$y$NPV_Agroforestry_System
decision2 <- apple_sheep_mc_simulation$y$NPV_Treeless_System

ggplot(data.frame(decision1, decision2), aes(x=decision1, y=decision2)) +
  geom_point(alpha=0.2, color="blue") +
  labs(title="Pareto Front: Agroforestry vs Treeless System",
       x="Agroforestry System (NPV)", y="Treeless System (NPV)")
```

```{r pareto_analysis-solution}
decision1 <- apple_sheep_mc_simulation$y$NPV_Agroforestry_System
decision2 <- apple_sheep_mc_simulation$y$NPV_Treeless_System

ggplot(data.frame(decision1, decision2), aes(x=decision1, y=decision2)) +
  geom_point(alpha=0.2, color="blue") +
  labs(title="Pareto Front: Agroforestry vs Treeless System",
       x="Agroforestry System (NPV)", y="Treeless System (NPV)")
```

---

## **6. Final Reflection**

- What insights did you gain from this tutorial?
- How would you improve your decision model?
- How does this relate to **real-world agroecology and conservation?**

```{r feedback, echo=FALSE}
textInput("feedback", "Share your key takeaways:", placeholder="Write your reflections here...")
```

---

## **Next Steps**

- Explore the `decisionSupport` package further
- Apply Monte Carlo simulations to your own research
- Continue refining expert-elicited models

```{r outro_message, echo=FALSE}
cat("Thanks for participating in this tutorial! 🎉")
```



